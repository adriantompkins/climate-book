

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Stochastic Model &#8212; Earth System Modelling</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/stochastic_model';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
  
    <p class="title logo__title">Earth System Modelling</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        
    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gl/tompkins%2Fearth-system-modelling/master?urlpath=tree/notebooks/stochastic_model.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>



<a href="https://gitlab.com/tompkins/earth-system-modelling" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-gitlab"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/stochastic_model.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Stochastic Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#offline-users">Offline users:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-run">Let’s run!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-parameters">Changing parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remember">remember!</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameters">Model Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="stochastic-model">
<h1>Stochastic Model<a class="headerlink" href="#stochastic-model" title="Permalink to this heading">#</a></h1>
<p>In this notebook we will make some investigations of the simple coarsening model presented in <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2022MS003231">Biagioli and Tompkins (2023)</a>.  Briefly, this model integrates a very simple equation for the column relative humidity <span class="math notranslate nohighlight">\(R\)</span> defined as</p>
<div class="math notranslate nohighlight">
\[    R =\frac{\int{\rho(q_v+q_l+q_i)dz}}{\int \rho q_s dz }. \]</div>
<p>The model is integrated on a CRM-like 2D lattice of grid cells of resolution O(1km) and the model’s governing equation is</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned} \dfrac{\partial R}{\partial t} = C - D - S$$, \\where 
- $C$ is the convective moistening term, 
- $D$ represents the spatial moisture exchange and
- $S$ is the subsidence drying.\\$C$ is modeled as a fast relaxation process at timescale $\tau_c$ towards a specified detrained water vapour and cloud condensate value, $D$ according to a down-gradient approach with constant coefficient $K$, $S$ as a relaxation term with uniform timescale towards a dry atmosphere. \\Thus the governing equation is \\$$ \dfrac{\partial R}{\partial t} =  \frac{(R_c-R)}{\tau_c} \mathcal{I}_c + K \nabla^2 R -\dfrac{R}{\tau_{\text{sub}}}, \end{aligned}\end{align} \]</div>
<p>The interesting behaviour of the model derives from the fact that <span class="math notranslate nohighlight">\(C\)</span> does not act uniformly on the entire domain, the convection occurs only in the grid cells where an indicator function is activated.  This is a stochastic process, where the convective cells are selected randomly, based on a sampling from a non-uniform, CRH-dependent probability distribution function (PDF). The PDF is derived from the nonlinear moisture-precipitation relationship by <a class="reference external" href="https://journals.ametsoc.org/view/journals/clim/17/7/1520-0442_2004_017_1517_rbwvpa_2.0.co_2.xml">Bretherton et al. (2004)</a>, revised by <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017GL076296">Rushley et al. (2018)</a>. It is also possible to distribute convective events over the day according to a diurnal cycle representation and account for the inhibition effect of cold pools but we won’t do this here.  Convective events, once activated, have a lifetime that is described by a Poisson process with a mean lifetime of 30 minutes by default.</p>
<p>before we start let’s see the packages we will need:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">uniform_filter1d</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">solve_circulant</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">ast</span> 
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">display</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/5f/gmzfbr6d0cbb3tn3_mkpdfnh0000gq/T/ipykernel_65057/1655216334.py:2: DeprecationWarning: Please import `uniform_filter1d` from the `scipy.ndimage` namespace; the `scipy.ndimage.filters` namespace is deprecated and will be removed in SciPy 2.0.0.
  from scipy.ndimage.filters import uniform_filter1d
</pre></div>
</div>
</div>
</div>
<p>here we define the default values used in the model. Each parameter is described, hopefully they are self-explanatory</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">defaults</span><span class="p">():</span>
    <span class="n">pars</span><span class="o">=</span><span class="p">{}</span>

    <span class="c1"># set this to a directory if you want an output netcdf file to play with </span>
    <span class="c1"># you will need to have ncview installed to examine it </span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
    
    <span class="c1">#Horizontal moisture diffusion coefficient (same in both directions, in m**2/s)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffK&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">10000.</span> <span class="c1"># 37500.</span>
    
    <span class="c1">#Steepness of the exponential function governing the choice of convective locations. Default is from TRMM retrieval version 7 (see Rushley et al. (2018), https://doi.org/10.1002/2017GL076296; see also Bretherton et al. (2004), https://doi.org/10.1175/1520-0442(2004)017&lt;1517:RBWVPA&gt;2.0.CO;2, and references therein)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">14.72</span>  <span class="c1"># 14.72</span>
     
    <span class="c1">#Subsidence drying timescale (in days, not seconds!)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">20.</span> <span class="c1"># 20.</span>
    
    <span class="c1">#Option to include the diurnal cycle, if = 0 no diurnal cycle is considered</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_opt&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

    <span class="c1"># Updrafts: </span>
    <span class="c1"># vertical velocity, used to set convective fraction</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;w_cnv&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">10.</span>
    
    <span class="c1"># timescale of convective moistening (in seconds)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_cnv&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">60.</span>

    <span class="c1"># Convective detrained value (saturation + detrained condensate, references for default value are from CloudSat)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_det&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">1.05</span>
    
    <span class="c1"># Average lifetime of a convective event</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cnv_lifetime&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">1800.</span>
    
    <span class="c1"># Coldpools:</span>
     <span class="c1"># Convective inhibition radius (km) due to the effect of cold pols. Setting cin_radius to a negative value switches off cold pools by default.</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">]</span><span class="o">=-</span><span class="mi">99</span>
    <span class="c1"># diffusion coefficient (m**2/s) and lifetime (seconds)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffCIN&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.25</span><span class="o">*</span><span class="mi">10</span><span class="o">*</span><span class="mf">50.e3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_cin&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span><span class="o">*</span><span class="mf">3600.</span>

    <span class="c1">#Different diurnal cycle specifications (active only if diurn_opt != 0)  </span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_a&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.6</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_p&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">2.0</span>

    <span class="c1">#Initial conditions (mean and standard deviation of the initial CRH field)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_init_mn&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.8</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_init_sd&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.0</span>

    <span class="c1">#Experimental configuration</span>
    
    <span class="c1">#Total simulated time (days) and timestep (seconds)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nday&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">5</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">60.</span>
    
    <span class="c1">#Domain size (m) and horizontal resolution (m)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;domain_xy&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">100.e3</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;dxy&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">2000.</span>

    <span class="c1">#Diagnostics for a netcdf output file with maps</span>
    <span class="c1">#Frequency of maps slices (one map every nfig_hr hours)</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nfig_hr&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">1.</span>

    <span class="c1"># plotting on?</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;lplot&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>

    <span class="c1"># turn off ldist for speed</span>
    <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;ldst&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">return</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<p>This is the ADI routine used for diffusion.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ADI</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a0</span><span class="p">)</span><span class="o">*</span><span class="n">fld</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span><span class="o">=</span><span class="n">solve_circulant</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="n">k</span><span class="p">,:])</span>
        <span class="n">g</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">a0</span><span class="o">-</span><span class="n">a2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">):</span>
            <span class="n">fld</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">solve_circulant</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">g</span><span class="p">[:,</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">fld</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>and this is the main code block…  we won’t go into details here…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">srdm</span><span class="p">(</span><span class="n">pars</span><span class="p">):</span>
    
    <span class="c1">#This option allows to test the ADI scheme with initial top-hat CRH profile</span>
    <span class="n">ltest</span><span class="o">=</span><span class="kc">False</span>
    
    <span class="c1">#-------------------</span>
    <span class="c1">#Definition of the spatial and temporal discretizations</span>
    <span class="c1">#-------------------</span>
    
    <span class="c1">#Some options are split from the dictionary to generate the meshes </span>
    <span class="n">dt</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;dt&quot;</span><span class="p">]</span>
    <span class="n">domain_x</span><span class="o">=</span><span class="n">domain_y</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;domain_xy&quot;</span><span class="p">]</span>
    <span class="n">dxy</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;dxy&quot;</span><span class="p">]</span>
    
    <span class="c1">#Total number of points in the x and y directions </span>
    <span class="n">nx</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">domain_x</span><span class="o">/</span><span class="n">dxy</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">ny</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">domain_y</span><span class="o">/</span><span class="n">dxy</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    
    <span class="c1">#Generation of the spatial numerical mesh, conversion to kilometers</span>
    <span class="n">x1d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">domain_x</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">y1d</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">domain_y</span><span class="p">,</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">dxkm</span><span class="o">=</span><span class="n">dxy</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x1d</span><span class="p">,</span> <span class="n">y1d</span><span class="p">)</span>
    
    <span class="c1">#Temporal discretization </span>
    <span class="n">nt</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nday&quot;</span><span class="p">]</span><span class="o">*</span><span class="mi">86400</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">times</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nt</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#-------------------</span>
    <span class="c1">#Auxiliary quantities </span>
    <span class="c1">#-------------------</span>
    
    <span class="c1">#Includes all the grid points (will be used in the computation of the distances from any cell to the nearest updraft, = 0 in case the cell itself is developing convection)</span>
    <span class="n">allidx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Flattened array containing a counting of the grid points</span>
    <span class="n">dummy_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1">#Initialization of the array for convective locations</span>
    <span class="n">cnv_idx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1">#-------------------</span>
    <span class="c1">#Definition of some derived quantities</span>
    <span class="c1">#-------------------</span>

    <span class="c1">#Subsidence velocity is defined as depth of the troposphere (=15 km)/tau_sub</span>
    <span class="n">w_sub</span><span class="o">=</span><span class="mf">15000.</span><span class="o">/</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">86400.</span><span class="p">)</span>
    
    <span class="c1">#The following quantity is used in the solution of the problem for the convective moistening part</span>
    <span class="n">dt_tau_cnv</span><span class="o">=</span><span class="n">dt</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_cnv&quot;</span><span class="p">]</span>
    
    <span class="c1">#At each time step, some grid cells may be randomly ceased. At the following step, new cells are born to substitute the dying ones. The value cnv_death sets the fixed probability of dying for a cell </span>
    <span class="n">cnv_death</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cnv_lifetime&quot;</span><span class="p">],</span><span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1">#-------------------</span>
    <span class="c1">#Quantities for the numerical solution of the diffusion-reaction problem dR/dt = -D-S with the Alternating Direction Implicit (ADI) scheme  </span>
    <span class="c1">#-------------------</span>
    
    <span class="c1">#Coefficients (see Supporting Information)</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffK&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dxy</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">beta</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">]</span><span class="o">*</span><span class="mf">86400.</span><span class="p">)</span>

    <span class="c1">#Initialization and storage of arrays for the solution of the circulant tridiagonal systems resulting from discretization with ADI</span>
    <span class="n">x_crh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="n">y_crh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">y_crh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">omega</span><span class="o">+</span><span class="n">alpha</span>
    <span class="n">y_crh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>
    <span class="n">y_crh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>

    <span class="n">z_crh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">z_crh</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">alpha</span>
    <span class="n">z_crh</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>
    <span class="n">z_crh</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta</span>

    <span class="c1"># plotting arrays</span>
    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;lplot&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">ts_time</span><span class="o">=</span><span class="n">times</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">3600</span> <span class="c1"># plotting time in hours</span>
        <span class="n">ts_crh_avg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">nt</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">ts_crh_std</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="n">nt</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">map_var</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">])</span>
        
        <span class="c1"># initialize plot</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">hdisplay</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">display_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># map</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>

        <span class="c1"># twinx</span>
        <span class="n">ax2</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        
        <span class="c1"># timeseries.</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    
    <span class="c1">#-------------------</span>
    <span class="c1">#Quantities for the solution of the problem with cold pools included, performed with ADI. The equation is dCIN/dt = -CIN/tau_cin + K∇**2 CIN.    </span>
    <span class="c1">#-------------------</span>

    <span class="n">beta_cin</span><span class="o">=</span><span class="mf">.5</span><span class="o">*</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffCIN&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">dxy</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">alpha_cin</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">beta_cin</span>
    <span class="n">omega_cin</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_cin&quot;</span><span class="p">]</span>
    <span class="n">x_cin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span>
    <span class="n">y_cin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">y_cin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">omega_cin</span><span class="o">+</span><span class="n">alpha_cin</span>
    <span class="n">y_cin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta_cin</span>
    <span class="n">y_cin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta_cin</span>

    <span class="n">z_cin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
    <span class="n">z_cin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">alpha_cin</span>
    <span class="n">z_cin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta_cin</span>
    <span class="n">z_cin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">beta_cin</span>
    
    <span class="c1">#-------------------</span>
    <span class="c1">#Netcdf output files</span>
    <span class="c1">#-------------------</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;toy_diffusion_2d model of atmosphere&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
        <span class="c1">#Name of the output files</span>
        <span class="n">tab</span><span class="o">=</span><span class="s2">&quot;diffK&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffK&quot;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;_tausub&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">])[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;_crhad&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;_cin_radius&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;_diurn&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_opt&quot;</span><span class="p">])</span>
        
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;opening output maps/stats:&quot;</span><span class="p">,</span><span class="n">tab</span><span class="p">)</span>
        
        <span class="c1">#Open the netcdf files (file 1 contains plan views, file 2 contains statistics timeseries)</span>
        <span class="n">nc1</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/td_maps_&quot;</span><span class="o">+</span><span class="n">tab</span><span class="o">+</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4&quot;</span><span class="p">)</span>
        <span class="n">nc2</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;/td_stats_&quot;</span><span class="o">+</span><span class="n">tab</span><span class="o">+</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NETCDF4&quot;</span><span class="p">)</span>
                
        <span class="c1">#File 1 (maps)</span>
        <span class="n">time1</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">var_time1</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        
        <span class="n">x1</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">var_x</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span><span class="s2">&quot;f4&quot;</span><span class="p">,(</span><span class="s2">&quot;x&quot;</span><span class="p">,))</span>
        <span class="n">var_x</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
        <span class="n">var_x</span><span class="p">[:]</span><span class="o">=</span><span class="n">x1d</span>
    
        <span class="n">y1</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">var_y</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span><span class="s2">&quot;f4&quot;</span><span class="p">,(</span><span class="s2">&quot;y&quot;</span><span class="p">,))</span>
        <span class="n">var_y</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
        <span class="n">var_y</span><span class="p">[:]</span><span class="o">=</span><span class="n">y1d</span>
        
        <span class="n">var_CRH</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CRH&quot;</span><span class="p">,</span><span class="s2">&quot;f4&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,))</span>
        <span class="n">var_CRH</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Column total water relative humidity&quot;</span>
        <span class="n">var_CRH</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;fraction&quot;</span>
        
        <span class="n">var_D2C</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;D2C&quot;</span><span class="p">,</span><span class="s2">&quot;f4&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,))</span>
        <span class="n">var_D2C</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Distance to nearest updraft&quot;</span>
        <span class="n">var_D2C</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
    
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">var_CIN</span><span class="o">=</span><span class="n">nc1</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CIN&quot;</span><span class="p">,</span><span class="s2">&quot;f4&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;x&quot;</span><span class="p">,))</span>
            <span class="n">var_CIN</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;fraction&quot;</span>
   
       <span class="c1">#Counter for the number of overwritings of the maps file </span>
        <span class="n">nccnt</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="c1">#File 2 (statistics)</span>
        <span class="n">dim_time2</span> <span class="o">=</span> <span class="n">nc2</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">var_time2</span> <span class="o">=</span> <span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        
        <span class="n">crh_mean</span> <span class="o">=</span> <span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CRH_mean&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">crh_mean</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;CRH domain mean&quot;</span>
        
        <span class="n">crh_std</span> <span class="o">=</span> <span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CRH_std&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">crh_std</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;CRH domain standard deviation&quot;</span>
        
        <span class="n">crh_in_new</span> <span class="o">=</span> <span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CRH_new_conv&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">crh_in_new</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;CRH value in new convective locations&quot;</span>
        <span class="n">crh_in_new</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;fraction&quot;</span>
        
        <span class="n">crh_driest</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;CRH_driest&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">crh_driest</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;Minimum CRH value&quot;</span>
        <span class="n">crh_driest</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;fraction&quot;</span>
    
        <span class="n">nc2_ncnv</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;nconv&quot;</span><span class="p">,</span><span class="s2">&quot;i8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">nc2_ncnv</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;Total number of convective events&quot;</span>
        <span class="n">nc2_ncnv</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;total number&quot;</span>
        
        <span class="n">d2c_95</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;D2C95&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">d2c_95</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;distance to convection 95th percentile&quot;</span>
        <span class="n">d2c_95</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
        
        <span class="n">d2c_max</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;D2C_max&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">d2c_max</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;distance to convection - maximum&quot;</span>
        <span class="n">d2c_max</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
        
        <span class="n">d2c_mean</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;D2C_mean&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">d2c_mean</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;distance to convection - mean&quot;</span>
        <span class="n">d2c_mean</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
        
        <span class="n">d2c_median</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s2">&quot;D2C_median&quot;</span><span class="p">,</span><span class="s2">&quot;f8&quot;</span><span class="p">,(</span><span class="s2">&quot;time&quot;</span><span class="p">,))</span>
        <span class="n">d2c_median</span><span class="o">.</span><span class="n">long_name</span><span class="o">=</span><span class="s2">&quot;distance to convection - median&quot;</span>
        <span class="n">d2c_median</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;km&quot;</span>
    
        <span class="n">var_time1</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="n">var_time2</span><span class="o">.</span><span class="n">units</span><span class="o">=</span><span class="s2">&quot;seconds since 2000-01-01 00:00:00.0&quot;</span>
        <span class="n">var_time1</span><span class="o">.</span><span class="n">calendar</span><span class="o">=</span><span class="n">var_time2</span><span class="o">.</span><span class="n">calendar</span><span class="o">=</span><span class="s2">&quot;gregorian&quot;</span>
        
        <span class="c1">#Global attributes for both files</span>
        <span class="n">nc1</span><span class="o">.</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;2D diffusion model, 2d slice snapshots&quot;</span>
        <span class="n">nc2</span><span class="o">.</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;2D diffusion model, Timeseries statistics&quot;</span>
        <span class="n">nc1</span><span class="o">.</span><span class="n">history</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">history</span><span class="o">=</span><span class="s2">&quot;Created &quot;</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">nc1</span><span class="o">.</span><span class="n">source</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">source</span><span class="o">=</span><span class="s2">&quot;Adrian Tompkins (tompkins@ictp.it)&quot;</span>
        <span class="n">nc1</span><span class="o">.</span><span class="n">center</span><span class="o">=</span><span class="n">nc2</span><span class="o">.</span><span class="n">center</span><span class="o">=</span><span class="s2">&quot;International Centre for Theoretical Physics (ICTP)&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">nc1</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">nc2</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">pars</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="c1">#All user-defined values in par are also saved as global attributes</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;- RUN PARS -&quot;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;------------&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">val</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="s2">&quot;=&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">)</span>
    <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;-----------&quot;</span><span class="p">)</span>   

    <span class="c1">#-------------------</span>
    <span class="c1">#Determining the size of the convective population</span>
    <span class="c1">#-------------------</span>

    <span class="c1">#Total number of events to distribute, based on a mass conservation argument by Tompkins and Craig (1998), https://doi.org/10.1002/qj.49712455013 </span>
    <span class="n">ncnv_tot</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nt</span><span class="o">*</span><span class="n">nx</span><span class="o">*</span><span class="n">ny</span><span class="o">*</span><span class="n">w_sub</span><span class="o">/</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;w_cnv&quot;</span><span class="p">])</span>

    <span class="c1">#3 different options to make the convective population size time-dependent, mimicking diurnal cycle</span>
    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_opt&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">pdiurn</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_opt&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">pdiurn</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_a&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">times</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mf">86400.</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_opt&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">pdiurn</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">times</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mf">86400.</span><span class="p">)</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diurn_p&quot;</span><span class="p">]</span>
    <span class="c1">#Normalization to get a probability</span>
    <span class="n">pdiurn</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pdiurn</span><span class="p">)</span>

    <span class="c1">#The convective events are distributed among the time steps but temporal variability in their outbreak is accounted for. The population size is not constant but a smoothing filter to lifetime of convection is then applied</span>
    <span class="n">ncnv</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">times</span><span class="p">,</span><span class="n">ncnv_tot</span><span class="p">,</span><span class="n">p</span><span class="o">=</span><span class="n">pdiurn</span><span class="p">),</span><span class="n">minlength</span><span class="o">=</span><span class="n">nt</span><span class="p">)</span>
    <span class="n">Nsmth</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cnv_lifetime&quot;</span><span class="p">]</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Nsmth</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">ncnv</span><span class="o">=</span><span class="n">uniform_filter1d</span><span class="p">(</span><span class="n">ncnv</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">Nsmth</span><span class="p">)</span>
        
    <span class="c1">#Storage for overflow. It may happen that too many convective events are still alive, and the number of new events to locate is negative. In this case the routine is designed to borrow events from future time steps and then to even the odds (see below)</span>
    <span class="n">ncnv_overflow</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="c1">#-------------------</span>
    <span class="c1">#Initial fields</span>
    <span class="c1">#-------------------</span>

    <span class="c1">#Initialization of the CRH field</span>
    <span class="n">crh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_init_mn&quot;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_init_sd&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">])</span>

    <span class="c1">#Initialization of the CRH field if the ADI solver is to be tested with initial top-hat profile</span>
    <span class="k">if</span> <span class="n">ltest</span><span class="p">:</span>
        <span class="n">mp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">radius</span><span class="o">=</span><span class="mi">20</span>
        <span class="n">crh</span><span class="p">[</span><span class="n">mp</span><span class="o">-</span><span class="n">radius</span><span class="p">:</span><span class="n">mp</span><span class="o">+</span><span class="n">radius</span><span class="p">,</span><span class="n">mp</span><span class="o">-</span><span class="n">radius</span><span class="p">:</span><span class="n">mp</span><span class="o">+</span><span class="n">radius</span><span class="p">]</span><span class="o">=</span><span class="mf">1.0</span>
    
    <span class="c1">#Initialization of the CIN array accounting for the action of coldpools</span>
    <span class="n">cin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

    <span class="c1">#Loop over time</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nt</span><span class="p">):</span>
         
        <span class="c1">#-------------------</span>
        <span class="c1">#Determining the number ncnv_new of NEW convective events</span>
        <span class="c1">#-------------------</span>
        
        <span class="c1">#Currently active columns</span>
        <span class="n">ncnv_curr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cnv_idx</span><span class="p">)</span>
        
        <span class="n">ncnv_new</span><span class="o">=</span><span class="n">ncnv</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">+</span><span class="n">ncnv_overflow</span><span class="o">-</span><span class="n">ncnv_curr</span>
        <span class="n">ncnv_overflow</span><span class="o">=</span><span class="mi">0</span>             
        <span class="k">if</span> <span class="p">(</span><span class="n">ncnv_new</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">ncnv_overflow</span><span class="o">=</span><span class="n">ncnv_new</span>                            
            <span class="n">ncnv_new</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="c1">#-------------------</span>
        <span class="c1">#Choice of the new convective locations according to the PDF derived from Bretherton et al. (2004)&#39;s relationship</span>
        <span class="c1">#-------------------</span>
        
        <span class="n">prob_crh</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">crh</span><span class="p">)</span>
        
        <span class="c1">#The cells already developing convection are excluded                                                                                                                                     </span>
        <span class="n">prob_crh</span><span class="o">*=</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cnv_idx</span><span class="p">)</span>
         
        <span class="n">prob_crh</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">prob_crh</span><span class="p">)</span>     
        <span class="n">prob</span><span class="o">=</span><span class="n">prob_crh</span>     
        
        <span class="c1">#Account for convective inhibiting action of coldpools</span>
        <span class="n">prob_cin</span><span class="o">=</span><span class="mf">1.0</span><span class="o">-</span><span class="n">cin</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>                                                                                                                                                                           
            <span class="n">prob</span><span class="o">*=</span><span class="n">prob_cin</span>                                                                                                                                                    
        
        <span class="c1">#Normalization to get a PDF</span>
        <span class="n">prob</span><span class="o">/=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>                                                                                                                                                               
        <span class="n">prob1d</span><span class="o">=</span><span class="n">prob</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="c1">#A number ncnv_new of new events are placed according to the PDF and the corresponding grid points are assigned value 1 for the indicator function                                                                                                                                                                    </span>
        <span class="n">coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">dummy_idx</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">ncnv_new</span><span class="p">),</span><span class="n">p</span><span class="o">=</span><span class="n">prob1d</span><span class="p">,</span><span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">new_loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">coords</span><span class="p">,(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span>
        <span class="n">cnv_idx</span><span class="p">[</span><span class="n">new_loc</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>                                                                                                                                                  

        <span class="c1">#-------------------</span>
        <span class="c1">#Numerical solution with Strang splitting</span>
        <span class="c1">#-------------------</span>
        
        <span class="c1">#Analytical solution of the problem dR/dt = C for half a time step </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ltest</span><span class="p">:</span>
            <span class="n">crh</span> <span class="o">=</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_det&quot;</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">crh</span><span class="o">-</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_det&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt_tau_cnv</span><span class="p">))</span><span class="o">*</span><span class="n">cnv_idx</span><span class="o">+</span><span class="n">crh</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cnv_idx</span><span class="p">)</span>

        <span class="c1">#Solution of the problem dR/dt = -D-S with ADI method for a full time step</span>
        <span class="n">crh</span> <span class="o">=</span> <span class="n">ADI</span><span class="p">(</span><span class="n">crh</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">x_crh</span><span class="p">,</span> <span class="n">y_crh</span><span class="p">,</span> <span class="n">z_crh</span><span class="p">)</span>

        <span class="c1">#Analytical solution of dR/dt = C for half a time step </span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ltest</span><span class="p">:</span>
            <span class="n">crh</span> <span class="o">=</span> <span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_det&quot;</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">crh</span><span class="o">-</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_det&quot;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">dt_tau_cnv</span><span class="p">))</span><span class="o">*</span><span class="n">cnv_idx</span><span class="o">+</span><span class="n">crh</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cnv_idx</span><span class="p">)</span>

        <span class="c1">#-------------------</span>
        <span class="c1">#Routine to calculate the distance to the nearest convective updraft</span>
        <span class="c1">#-------------------</span>
        
        <span class="n">cnv_coords</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cnv_idx</span><span class="p">)</span>
        <span class="n">ncnv_curr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cnv_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nc2_ncnv</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">ncnv_curr</span>
        
        <span class="c1">#The procedure takes into account the doubly-periodic nature of the computational domain</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;ldst&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ncnv_curr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">xoff</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="o">-</span><span class="n">nx</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">yoff</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">ny</span><span class="p">,</span><span class="n">ny</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">xoff</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">yoff</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">j9</span><span class="o">=</span><span class="n">cnv_coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">jo</span><span class="o">=</span><span class="n">cnv_coords</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">jo</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">+=</span><span class="n">xoff</span>
                            <span class="n">jo</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">+=</span><span class="n">yoff</span>
                            <span class="n">j9</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">j9</span><span class="p">,</span><span class="n">jo</span><span class="p">))</span>
                <span class="n">tree</span><span class="o">=</span><span class="n">spatial</span><span class="o">.</span><span class="n">cKDTree</span><span class="p">(</span><span class="n">j9</span><span class="p">)</span>
                <span class="n">cnvdst</span><span class="p">,</span><span class="n">minidx</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">allidx</span><span class="p">)</span>
                <span class="n">cnvdst</span><span class="o">=</span><span class="n">cnvdst</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>
                <span class="n">cnvdst</span><span class="o">*=</span><span class="n">dxkm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cnvdst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span><span class="o">*</span><span class="mf">1.e6</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnvdst</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">])</span>

        <span class="c1">#Account for cold pool inhibition effect </span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">maskcin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cnvdst</span><span class="o">&lt;</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="c1">#cin = 1 for the points within distance cin_radius from the convective source</span>
            <span class="n">cin</span><span class="o">=</span><span class="n">cin</span><span class="o">+</span><span class="n">maskcin</span> 
            <span class="n">cin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                   
            <span class="c1">#Solution of the differential problem for CIN with ADI method            </span>
            <span class="n">cin</span> <span class="o">=</span> <span class="n">ADI</span><span class="p">(</span><span class="n">cin</span><span class="p">,</span> <span class="n">alpha_cin</span><span class="p">,</span> <span class="n">beta_cin</span><span class="p">,</span> <span class="n">omega_cin</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">x_cin</span><span class="p">,</span> <span class="n">y_cin</span><span class="p">,</span> <span class="n">z_cin</span><span class="p">)</span>
            <span class="n">cin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">cin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#At each time step, some convective cells may be randomly killed</span>
        <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span><span class="n">nx</span><span class="p">))</span><span class="o">&lt;=</span><span class="n">cnv_death</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">cnv_idx</span><span class="o">*=</span><span class="n">mask</span>
        <span class="n">cnv_loc</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">cnv_idx</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>    
 
        <span class="c1">#-------------------</span>
        <span class="c1">#Write netcdf output</span>
        <span class="c1">#-------------------</span>
 
        <span class="c1">#At each time step for timeseries</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">var_time2</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">it</span><span class="o">*</span><span class="n">dt</span>
            <span class="n">crh_mean</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">crh</span><span class="p">)</span>
            <span class="n">crh_std</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">crh</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ncnv_new</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">crh_in_new</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">crh</span><span class="p">[</span><span class="n">new_loc</span><span class="p">])</span>
            <span class="n">crh_driest</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">crh</span><span class="p">)</span>
        
            <span class="n">d2c_mean</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cnvdst</span><span class="p">)</span>
            <span class="n">d2c_median</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">cnvdst</span><span class="p">)</span>
            <span class="n">d2c_max</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cnvdst</span><span class="p">)</span>
            <span class="n">d2c_95</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">cnvdst</span><span class="p">,</span><span class="mi">95</span><span class="p">)</span>
            
        <span class="c1"># Save the variable you want for the time series here (can adapt if you want more variables)</span>
        <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;lplot&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">ts_crh_avg</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">crh</span><span class="p">)</span>
            <span class="n">ts_crh_std</span><span class="p">[</span><span class="n">it</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">crh</span><span class="p">)</span>
            
        <span class="c1">#Every nfig_hr hours for maps</span>
        
        <span class="k">if</span> <span class="n">it</span><span class="o">%</span><span class="k">int</span>(pars[&quot;nfig_hr&quot;]*3600/dt)==0:                
            <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">var_time1</span><span class="p">[</span><span class="n">nccnt</span><span class="p">]</span><span class="o">=</span><span class="n">it</span><span class="o">*</span><span class="n">dt</span>
                <span class="n">var_CRH</span><span class="p">[</span><span class="n">nccnt</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">crh</span>     
                <span class="n">var_D2C</span><span class="p">[</span><span class="n">nccnt</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">cnvdst</span>     
                <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;cin_radius&quot;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">var_CIN</span><span class="p">[</span><span class="n">nccnt</span><span class="p">,:,:]</span><span class="o">=</span><span class="n">cin</span>       
                <span class="n">nccnt</span><span class="o">+=</span><span class="mi">1</span>
                
            <span class="c1"># update plot </span>
            <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;lplot&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="c1"># pass the map variables that you want to map:</span>
                <span class="c1"># crh</span>
                <span class="n">itime</span><span class="o">=</span><span class="n">it</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">3600</span>
                <span class="n">plot_slice</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="n">itime</span><span class="p">,</span><span class="n">ts_time</span><span class="p">,</span><span class="n">x1d</span><span class="p">,</span><span class="n">y1d</span><span class="p">,</span><span class="n">ts_crh_avg</span><span class="p">,</span><span class="n">ts_crh_std</span><span class="p">,</span><span class="n">crh</span><span class="p">,</span><span class="n">cnvdst</span><span class="p">,</span><span class="n">hdisplay</span><span class="p">,</span><span class="n">pars</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nc1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">nc2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_slice</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="n">itime</span><span class="p">,</span><span class="n">time_ax</span><span class="p">,</span><span class="n">x_ax</span><span class="p">,</span><span class="n">y_ax</span><span class="p">,</span><span class="n">ts_avg</span><span class="p">,</span><span class="n">ts_std</span><span class="p">,</span><span class="n">map_var</span><span class="p">,</span><span class="n">cnvdst</span><span class="p">,</span><span class="n">hdisplay</span><span class="p">,</span><span class="n">pars</span><span class="p">):</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    
    <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
    <span class="n">pim</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x_ax</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="n">y_ax</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span><span class="n">map_var</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;coolwarm_r&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">it</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pim</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;time &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">itime</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot; (hours)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X (km)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y (km)&#39;</span><span class="p">)</span>
    
    <span class="c1"># timeseries</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (hours)&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">time_ax</span><span class="p">)])</span>

    <span class="c1"># std</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_ax</span><span class="p">,</span><span class="n">ts_std</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;std dev&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time_ax</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">ts_std</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;CRH sigma&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># mean</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_ax</span><span class="p">,</span><span class="n">ts_avg</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time_ax</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">ts_avg</span><span class="p">[</span><span class="n">it</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">facecolors</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;K:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffK&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span>
                    <span class="s2">&quot; ad:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span>
                    <span class="s2">&quot; Tsub:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
    <span class="n">hdisplay</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<section id="offline-users">
<h2>Offline users:<a class="headerlink" href="#offline-users" title="Permalink to this heading">#</a></h2>
<p>If you change the “pars[outdir]” fron None to a directory you will get the output stored into two netcdf files. The first one, <strong>td_stats</strong>, contains the time series of several variables of interest, such as the domain-mean and spatial standard deviation of <span class="math notranslate nohighlight">\(R\)</span> or the statistics of the distribution of distances to the nearest convection. The second one, <strong>td_maps</strong>, instead stores spatial maps of <span class="math notranslate nohighlight">\(R\)</span> and of the distance to the nearest convection. The files can be opened with \texttt{ncview}.  By default, this notebook just plots the standard deviation of CRH timeseries and hourly maps of CRH.</p>
</section>
<section id="let-s-run">
<h2>Let’s run!<a class="headerlink" href="#let-s-run" title="Permalink to this heading">#</a></h2>
<p>This is how we run an integration</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pars</span><span class="o">=</span><span class="n">defaults</span><span class="p">()</span>
<span class="n">srdm</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/550d19758b3a814898673132bd04c5835b6b0c09e7b0b6c6a68a21d04757c664.png" src="../_images/550d19758b3a814898673132bd04c5835b6b0c09e7b0b6c6a68a21d04757c664.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>toy_diffusion_2d model of atmosphere
------------
- RUN PARS -
------------
outdir = None
diffK = 10000.0
crh_ad = 14.72
tau_sub = 20.0
diurn_opt = 0
w_cnv = 10.0
tau_cnv = 60.0
crh_det = 1.05
cnv_lifetime = 1800.0
cin_radius = -99
diffCIN = 125000.0
tau_cin = 10800.0
diurn_a = 0.6
diurn_p = 2.0
crh_init_mn = 0.8
crh_init_sd = 0.0
nday = 5
dt = 60.0
domain_xy = 100000.0
dxy = 2000.0
nfig_hr = 1.0
lplot = True
ldst = False
-----------
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">pars</span><span class="o">=</span><span class="n">defaults</span><span class="p">()</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">srdm</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>

<span class="nn">Cell In[4], line 405,</span> in <span class="ni">srdm</span><span class="nt">(pars)</span>
<span class="g g-Whitespace">    </span><span class="mi">401</span>         <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;lplot&quot;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">402</span>             <span class="c1"># pass the map variables that you want to map:</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span>             <span class="c1"># crh</span>
<span class="g g-Whitespace">    </span><span class="mi">404</span>             <span class="n">itime</span><span class="o">=</span><span class="n">it</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="mi">3600</span>
<span class="ne">--&gt; </span><span class="mi">405</span>             <span class="n">plot_slice</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">ax2</span><span class="p">,</span><span class="n">it</span><span class="p">,</span><span class="n">itime</span><span class="p">,</span><span class="n">ts_time</span><span class="p">,</span><span class="n">x1d</span><span class="p">,</span><span class="n">y1d</span><span class="p">,</span><span class="n">ts_crh_avg</span><span class="p">,</span><span class="n">ts_crh_std</span><span class="p">,</span><span class="n">crh</span><span class="p">,</span><span class="n">cnvdst</span><span class="p">,</span><span class="n">hdisplay</span><span class="p">,</span><span class="n">pars</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">407</span> <span class="k">if</span> <span class="n">pars</span><span class="p">[</span><span class="s2">&quot;outdir&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">408</span>     <span class="n">nc1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="nn">Cell In[5], line 34,</span> in <span class="ni">plot_slice</span><span class="nt">(fig, ax, ax2, it, itime, time_ax, x_ax, y_ax, ts_avg, ts_std, map_var, cnvdst, hdisplay, pars)</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span> <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;K:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;diffK&quot;</span><span class="p">],</span><span class="mi">0</span><span class="p">))</span><span class="o">+</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span>                 <span class="s2">&quot; ad:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span>                 <span class="s2">&quot; Tsub:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span>
<span class="ne">---&gt; </span><span class="mi">34</span> <span class="n">hdisplay</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/display_functions.py:374,</span> in <span class="ni">DisplayHandle.update</span><span class="nt">(self, obj, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">364</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">365</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Update existing displays with my id</span>
<span class="g g-Whitespace">    </span><span class="mi">366</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">367</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span><span class="sd">         additional keyword arguments passed to update_display</span>
<span class="g g-Whitespace">    </span><span class="mi">373</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">374</span>     <span class="n">update_display</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">display_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/display_functions.py:326,</span> in <span class="ni">update_display</span><span class="nt">(obj, display_id, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;Update an existing display by id</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">314</span><span class="sd"> Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">323</span><span class="sd"> :func:`display`</span>
<span class="g g-Whitespace">    </span><span class="mi">324</span><span class="sd"> &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">325</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;update&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="ne">--&gt; </span><span class="mi">326</span> <span class="n">display</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">display_id</span><span class="o">=</span><span class="n">display_id</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/display_functions.py:298,</span> in <span class="ni">display</span><span class="nt">(include, exclude, metadata, transient, display_id, raw, clear, *objs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">publish_display_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">297</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">298</span>     <span class="n">format_dict</span><span class="p">,</span> <span class="n">md_dict</span> <span class="o">=</span> <span class="nb">format</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="n">include</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="k">if</span> <span class="ow">not</span> <span class="n">format_dict</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">300</span>         <span class="c1"># nothing to display (e.g. _ipython_display_ took over)</span>
<span class="g g-Whitespace">    </span><span class="mi">301</span>         <span class="k">continue</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/formatters.py:238,</span> in <span class="ni">DisplayFormatter.format</span><span class="nt">(self, obj, include, exclude)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span> <span class="n">md</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">238</span>     <span class="n">data</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span> <span class="k">except</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span>     <span class="c1"># FIXME: log the exception</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>     <span class="k">raise</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/decorator.py:232,</span> in <span class="ni">decorate.&lt;locals&gt;.fun</span><span class="nt">(*args, **kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwsyntax</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">fix</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">232</span> <span class="k">return</span> <span class="n">caller</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">extras</span> <span class="o">+</span> <span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/formatters.py:282,</span> in <span class="ni">catch_format_error</span><span class="nt">(method, self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">280</span><span class="w"> </span><span class="sd">&quot;&quot;&quot;show traceback on failed format call&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">281</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">282</span>     <span class="n">r</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">283</span> <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">284</span>     <span class="c1"># don&#39;t warn on NotImplementedErrors</span>
<span class="g g-Whitespace">    </span><span class="mi">285</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_return</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/formatters.py:402,</span> in <span class="ni">BaseFormatter.__call__</span><span class="nt">(self, obj)</span>
<span class="g g-Whitespace">    </span><span class="mi">400</span>     <span class="k">pass</span>
<span class="g g-Whitespace">    </span><span class="mi">401</span> <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">402</span>     <span class="k">return</span> <span class="n">printer</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">403</span> <span class="c1"># Finally look for special method names</span>
<span class="g g-Whitespace">    </span><span class="mi">404</span> <span class="n">method</span> <span class="o">=</span> <span class="n">get_real_method</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">print_method</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/IPython/core/pylabtools.py:170,</span> in <span class="ni">print_figure</span><span class="nt">(fig, fmt, bbox_inches, base64, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">167</span>     <span class="kn">from</span> <span class="nn">matplotlib.backend_bases</span> <span class="kn">import</span> <span class="n">FigureCanvasBase</span>
<span class="g g-Whitespace">    </span><span class="mi">168</span>     <span class="n">FigureCanvasBase</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">170</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">print_figure</span><span class="p">(</span><span class="n">bytes_io</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">171</span> <span class="n">data</span> <span class="o">=</span> <span class="n">bytes_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span> <span class="k">if</span> <span class="n">fmt</span> <span class="o">==</span> <span class="s1">&#39;svg&#39;</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/backend_bases.py:2204,</span> in <span class="ni">FigureCanvasBase.print_figure</span><span class="nt">(self, filename, dpi, facecolor, edgecolor, orientation, format, bbox_inches, pad_inches, bbox_extra_artists, backend, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2200</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2201</span>     <span class="c1"># _get_renderer may change the figure dpi (as vector formats</span>
<span class="g g-Whitespace">   </span><span class="mi">2202</span>     <span class="c1"># force the figure dpi to 72), so we need to set it again here.</span>
<span class="g g-Whitespace">   </span><span class="mi">2203</span>     <span class="k">with</span> <span class="n">cbook</span><span class="o">.</span><span class="n">_setattr_cm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">2204</span>         <span class="n">result</span> <span class="o">=</span> <span class="n">print_method</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2205</span>             <span class="n">filename</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2206</span>             <span class="n">facecolor</span><span class="o">=</span><span class="n">facecolor</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2207</span>             <span class="n">edgecolor</span><span class="o">=</span><span class="n">edgecolor</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2208</span>             <span class="n">orientation</span><span class="o">=</span><span class="n">orientation</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2209</span>             <span class="n">bbox_inches_restore</span><span class="o">=</span><span class="n">_bbox_inches_restore</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2210</span>             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2211</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2212</span>     <span class="k">if</span> <span class="n">bbox_inches</span> <span class="ow">and</span> <span class="n">restore_bbox</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/backend_bases.py:2054,</span> in <span class="ni">FigureCanvasBase._switch_canvas_and_return_print_method.&lt;locals&gt;.&lt;lambda&gt;</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2050</span>     <span class="n">optional_kws</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Passed by print_figure for other renderers.</span>
<span class="g g-Whitespace">   </span><span class="mi">2051</span>         <span class="s2">&quot;dpi&quot;</span><span class="p">,</span> <span class="s2">&quot;facecolor&quot;</span><span class="p">,</span> <span class="s2">&quot;edgecolor&quot;</span><span class="p">,</span> <span class="s2">&quot;orientation&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2052</span>         <span class="s2">&quot;bbox_inches_restore&quot;</span><span class="p">}</span>
<span class="g g-Whitespace">   </span><span class="mi">2053</span>     <span class="n">skip</span> <span class="o">=</span> <span class="n">optional_kws</span> <span class="o">-</span> <span class="p">{</span><span class="o">*</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
<span class="ne">-&gt; </span><span class="mi">2054</span>     <span class="n">print_method</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">meth</span><span class="p">)(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">meth</span><span class="p">(</span>
<span class="nn">   2055         *args, **{k: v for k, v</span> in <span class="ni">kwargs.items</span><span class="nt">() if k not in skip}))</span>
<span class="g g-Whitespace">   </span><span class="mi">2056</span> <span class="k">else</span><span class="p">:</span>  <span class="c1"># Let third-parties do as they see fit.</span>
<span class="g g-Whitespace">   </span><span class="mi">2057</span>     <span class="n">print_method</span> <span class="o">=</span> <span class="n">meth</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py:496,</span> in <span class="ni">FigureCanvasAgg.print_png</span><span class="nt">(self, filename_or_obj, metadata, pil_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">449</span> <span class="k">def</span> <span class="nf">print_png</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_or_obj</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pil_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">450</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">451</span><span class="sd">     Write the figure to a PNG file.</span>
<span class="g g-Whitespace">    </span><span class="mi">452</span><span class="sd"> </span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">    </span><span class="mi">494</span><span class="sd">         *metadata*, including the default &#39;Software&#39; key.</span>
<span class="g g-Whitespace">    </span><span class="mi">495</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">496</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_print_pil</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">,</span> <span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">pil_kwargs</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py:444,</span> in <span class="ni">FigureCanvasAgg._print_pil</span><span class="nt">(self, filename_or_obj, fmt, pil_kwargs, metadata)</span>
<span class="g g-Whitespace">    </span><span class="mi">439</span> <span class="k">def</span> <span class="nf">_print_pil</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_or_obj</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">pil_kwargs</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">440</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">441</span><span class="sd">     Draw the canvas, then save it using `.image.imsave` (to which</span>
<span class="g g-Whitespace">    </span><span class="mi">442</span><span class="sd">     *pil_kwargs* and *metadata* are forwarded).</span>
<span class="g g-Whitespace">    </span><span class="mi">443</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">444</span>     <span class="n">FigureCanvasAgg</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">445</span>     <span class="n">mpl</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">imsave</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">446</span>         <span class="n">filename_or_obj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer_rgba</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="n">fmt</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;upper&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">447</span>         <span class="n">dpi</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">dpi</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">pil_kwargs</span><span class="o">=</span><span class="n">pil_kwargs</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py:387,</span> in <span class="ni">FigureCanvasAgg.draw</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span> <span class="c1"># Acquire a lock on the shared font cache.</span>
<span class="g g-Whitespace">    </span><span class="mi">385</span> <span class="k">with</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">_wait_cursor_for_draw_cm</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span>       <span class="k">else</span> <span class="n">nullcontext</span><span class="p">()):</span>
<span class="ne">--&gt; </span><span class="mi">387</span>     <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">388</span>     <span class="c1"># A GUI class may be need to update a window using this draw, so</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>     <span class="c1"># don&#39;t forget to call the superclass.</span>
<span class="g g-Whitespace">    </span><span class="mi">390</span>     <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:95,</span> in <span class="ni">_finalize_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer, *args, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">93</span> <span class="nd">@wraps</span><span class="p">(</span><span class="n">draw</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">94</span> <span class="k">def</span> <span class="nf">draw_wrapper</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">95</span>     <span class="n">result</span> <span class="o">=</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">96</span>     <span class="k">if</span> <span class="n">renderer</span><span class="o">.</span><span class="n">_rasterizing</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">97</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">stop_rasterizing</span><span class="p">()</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:72,</span> in <span class="ni">allow_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">start_filter</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/figure.py:3162,</span> in <span class="ni">Figure.draw</span><span class="nt">(self, renderer)</span>
<span class="g g-Whitespace">   </span><span class="mi">3159</span>             <span class="c1"># ValueError can occur when resizing a window.</span>
<span class="g g-Whitespace">   </span><span class="mi">3161</span>     <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">3162</span>     <span class="n">mimage</span><span class="o">.</span><span class="n">_draw_list_compositing_images</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3163</span>         <span class="n">renderer</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">artists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">suppressComposite</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3165</span>     <span class="n">renderer</span><span class="o">.</span><span class="n">close_group</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3166</span> <span class="k">finally</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/image.py:132,</span> in <span class="ni">_draw_list_compositing_images</span><span class="nt">(renderer, parent, artists, suppress_composite)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span> <span class="k">if</span> <span class="n">not_composite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_images</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">artists</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">132</span>         <span class="n">a</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="c1"># Composite any adjacent images together</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>     <span class="n">image_group</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:72,</span> in <span class="ni">allow_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">start_filter</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/axes/_base.py:3137,</span> in <span class="ni">_AxesBase.draw</span><span class="nt">(self, renderer)</span>
<span class="g g-Whitespace">   </span><span class="mi">3134</span> <span class="k">if</span> <span class="n">artists_rasterized</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">3135</span>     <span class="n">_draw_rasterized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">artists_rasterized</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">3137</span> <span class="n">mimage</span><span class="o">.</span><span class="n">_draw_list_compositing_images</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">3138</span>     <span class="n">renderer</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">artists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">suppressComposite</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3140</span> <span class="n">renderer</span><span class="o">.</span><span class="n">close_group</span><span class="p">(</span><span class="s1">&#39;axes&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">3141</span> <span class="bp">self</span><span class="o">.</span><span class="n">stale</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/image.py:132,</span> in <span class="ni">_draw_list_compositing_images</span><span class="nt">(renderer, parent, artists, suppress_composite)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span> <span class="k">if</span> <span class="n">not_composite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">has_images</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">artists</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">132</span>         <span class="n">a</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="c1"># Composite any adjacent images together</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>     <span class="n">image_group</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:72,</span> in <span class="ni">allow_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">start_filter</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/axis.py:1427,</span> in <span class="ni">Axis.draw</span><span class="nt">(self, renderer)</span>
<span class="g g-Whitespace">   </span><span class="mi">1424</span> <span class="n">tlb1</span><span class="p">,</span> <span class="n">tlb2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ticklabel_bboxes</span><span class="p">(</span><span class="n">ticks_to_draw</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1426</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ticks_to_draw</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1427</span>     <span class="n">tick</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1429</span> <span class="c1"># Shift label away from axes to avoid overlapping ticklabels.</span>
<span class="g g-Whitespace">   </span><span class="mi">1430</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_label_position</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:72,</span> in <span class="ni">allow_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">start_filter</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/axis.py:277,</span> in <span class="ni">Tick.draw</span><span class="nt">(self, renderer)</span>
<span class="g g-Whitespace">    </span><span class="mi">274</span> <span class="n">renderer</span><span class="o">.</span><span class="n">open_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_gid</span><span class="p">())</span>
<span class="g g-Whitespace">    </span><span class="mi">275</span> <span class="k">for</span> <span class="n">artist</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">gridline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick1line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tick2line</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">276</span>                <span class="bp">self</span><span class="o">.</span><span class="n">label1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">label2</span><span class="p">]:</span>
<span class="ne">--&gt; </span><span class="mi">277</span>     <span class="n">artist</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">278</span> <span class="n">renderer</span><span class="o">.</span><span class="n">close_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">279</span> <span class="bp">self</span><span class="o">.</span><span class="n">stale</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/artist.py:72,</span> in <span class="ni">allow_rasterization.&lt;locals&gt;.draw_wrapper</span><span class="nt">(artist, renderer)</span>
<span class="g g-Whitespace">     </span><span class="mi">69</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">70</span>         <span class="n">renderer</span><span class="o">.</span><span class="n">start_filter</span><span class="p">()</span>
<span class="ne">---&gt; </span><span class="mi">72</span>     <span class="k">return</span> <span class="n">draw</span><span class="p">(</span><span class="n">artist</span><span class="p">,</span> <span class="n">renderer</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">73</span> <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span>     <span class="k">if</span> <span class="n">artist</span><span class="o">.</span><span class="n">get_agg_filter</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/lines.py:751,</span> in <span class="ni">Line2D.draw</span><span class="nt">(self, renderer)</span>
<span class="g g-Whitespace">    </span><span class="mi">748</span>     <span class="k">return</span>
<span class="g g-Whitespace">    </span><span class="mi">750</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invalidy</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invalidx</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">751</span>     <span class="bp">self</span><span class="o">.</span><span class="n">recache</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">752</span> <span class="bp">self</span><span class="o">.</span><span class="n">ind_offset</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Needed for contains() method.</span>
<span class="g g-Whitespace">    </span><span class="mi">753</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subslice</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">:</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/matplotlib/lines.py:683,</span> in <span class="ni">Line2D.recache</span><span class="nt">(self, always)</span>
<span class="g g-Whitespace">    </span><span class="mi">680</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">681</span>     <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span>
<span class="ne">--&gt; </span><span class="mi">683</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">broadcast_arrays</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">684</span> <span class="bp">self</span><span class="o">.</span><span class="n">_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xy</span><span class="o">.</span><span class="n">T</span>  <span class="c1"># views</span>
<span class="g g-Whitespace">    </span><span class="mi">686</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subslice</span> <span class="o">=</span> <span class="kc">False</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/numpy/lib/_stride_tricks_impl.py:544,</span> in <span class="ni">broadcast_arrays</span><span class="nt">(subok, *args)</span>
<span class="g g-Whitespace">    </span><span class="mi">537</span> <span class="c1"># nditer is not used here to avoid the limit of 32 arrays.</span>
<span class="g g-Whitespace">    </span><span class="mi">538</span> <span class="c1"># Otherwise, something like the following one-liner would suffice:</span>
<span class="g g-Whitespace">    </span><span class="mi">539</span> <span class="c1"># return np.nditer(args, flags=[&#39;multi_index&#39;, &#39;zerosize_ok&#39;],</span>
<span class="g g-Whitespace">    </span><span class="mi">540</span> <span class="c1">#                  order=&#39;C&#39;).itviews</span>
<span class="g g-Whitespace">    </span><span class="mi">542</span> <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_m</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="n">subok</span><span class="p">)</span> <span class="k">for</span> <span class="n">_m</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="ne">--&gt; </span><span class="mi">544</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">_broadcast_shape</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">546</span> <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">array</span> <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">shape</span>
<span class="g g-Whitespace">    </span><span class="mi">547</span>           <span class="k">else</span> <span class="n">_broadcast_to</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="n">subok</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">548</span>                           <span class="k">for</span> <span class="n">array</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">549</span> <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="nn">File /opt/homebrew/Caskroom/miniconda/base/lib/python3.12/site-packages/numpy/lib/_stride_tricks_impl.py:421,</span> in <span class="ni">_broadcast_shape</span><span class="nt">(*args)</span>
<span class="g g-Whitespace">    </span><span class="mi">419</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[:</span><span class="mi">32</span><span class="p">])</span>
<span class="g g-Whitespace">    </span><span class="mi">420</span> <span class="c1"># unfortunately, it cannot handle 32 or more arguments directly</span>
<span class="ne">--&gt; </span><span class="mi">421</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">),</span> <span class="mi">31</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">422</span>     <span class="c1"># ironically, np.broadcast does not properly handle np.broadcast</span>
<span class="g g-Whitespace">    </span><span class="mi">423</span>     <span class="c1"># objects (it treats them as scalars)</span>
<span class="g g-Whitespace">    </span><span class="mi">424</span>     <span class="c1"># use broadcasting to avoid allocating the full array</span>
<span class="g g-Whitespace">    </span><span class="mi">425</span>     <span class="n">b</span> <span class="o">=</span> <span class="n">broadcast_to</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">426</span>     <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="n">pos</span><span class="p">:(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)])</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
<img alt="../_images/ed70d36faa77e5066496325fb0988f974f99a9da216e543d32710f92815a592f.png" src="../_images/ed70d36faa77e5066496325fb0988f974f99a9da216e543d32710f92815a592f.png" />
</div>
</div>
</section>
<section id="changing-parameters">
<h2>Changing parameters<a class="headerlink" href="#changing-parameters" title="Permalink to this heading">#</a></h2>
<p>It is straightforward to change model parameters and rerun the code.  For example the first experiment was with a small 100x100km2 domain. Now let’s try a larger domain.  If you forget what the parameters are called just take a look at the variable pars.  Okay, here we go…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>
<span class="n">srdm</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c0625fa48b0950ed0590a375fe6352f0ffc533914a750b6e57d3313273a9fa86.png" src="../_images/c0625fa48b0950ed0590a375fe6352f0ffc533914a750b6e57d3313273a9fa86.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>toy_diffusion_2d model of atmosphere
------------
- RUN PARS -
------------
outdir = None
diffK = 10000.0
crh_ad = 14.72
tau_sub = 10
diurn_opt = 0
w_cnv = 10.0
tau_cnv = 60.0
crh_det = 1.05
cnv_lifetime = 1800.0
cin_radius = -99
diffCIN = 125000.0
tau_cin = 10800.0
diurn_a = 0.6
diurn_p = 2.0
crh_init_mn = 0.8
crh_init_sd = 0.0
nday = 5
dt = 60.0
domain_xy = 100000.0
dxy = 2000.0
nfig_hr = 1.0
lplot = True
ldst = False
-----------
</pre></div>
</div>
<img alt="../_images/c0625fa48b0950ed0590a375fe6352f0ffc533914a750b6e57d3313273a9fa86.png" src="../_images/c0625fa48b0950ed0590a375fe6352f0ffc533914a750b6e57d3313273a9fa86.png" />
</div>
</div>
<div class="alert alert-block alert-warning">
<section id="remember">
<h3>remember!<a class="headerlink" href="#remember" title="Permalink to this heading">#</a></h3>
<p>that your pars dictionary now contains the new value for domain size. If you change another parameter, say, resolution, both changes will be in the simulation. If you want to change just one parameter, you can always reset the defaults easily with a renewed call to the default function like this:</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reset defaults first</span>
<span class="n">pars</span><span class="o">=</span><span class="n">defaults</span><span class="p">()</span> 

<span class="c1"># set simulation parameters</span>
<span class="n">pars</span><span class="p">[</span><span class="s2">&quot;crh_ad&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">16.5</span>
<span class="n">pars</span><span class="p">[</span><span class="s2">&quot;domain_xy&quot;</span><span class="p">]</span><span class="o">=</span><span class="mf">500e3</span>
<span class="n">pars</span><span class="p">[</span><span class="s2">&quot;resolution&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">2000</span>
<span class="n">pars</span><span class="p">[</span><span class="s2">&quot;tau_sub&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>
<span class="n">pars</span><span class="p">[</span><span class="s2">&quot;nday&quot;</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span>

<span class="c1"># run the model </span>
<span class="n">srdm</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/208f3ae244be184abaab56dc005e1049e7eadcb120d301a296498742edece701.png" src="../_images/208f3ae244be184abaab56dc005e1049e7eadcb120d301a296498742edece701.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>toy_diffusion_2d model of atmosphere
------------
- RUN PARS -
------------
outdir = None
diffK = 10000.0
crh_ad = 16.5
tau_sub = 10
diurn_opt = 0
w_cnv = 10.0
tau_cnv = 60.0
crh_det = 1.05
cnv_lifetime = 1800.0
cin_radius = -99
diffCIN = 125000.0
tau_cin = 10800.0
diurn_a = 0.6
diurn_p = 2.0
crh_init_mn = 0.8
crh_init_sd = 0.0
nday = 10
dt = 60.0
domain_xy = 500000.0
dxy = 2000.0
nfig_hr = 1.0
lplot = True
ldst = False
resolution = 2000
-----------
</pre></div>
</div>
<img alt="../_images/208f3ae244be184abaab56dc005e1049e7eadcb120d301a296498742edece701.png" src="../_images/208f3ae244be184abaab56dc005e1049e7eadcb120d301a296498742edece701.png" />
</div>
</div>
</section>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this heading">#</a></h2>
<section id="model-parameters">
<h3>Model Parameters<a class="headerlink" href="#model-parameters" title="Permalink to this heading">#</a></h3>
<p>The main input parameters we will play with today are:</p>
<ul class="simple">
<li><p><strong>diffK</strong> the horizontal moisture transport efficiency <span class="math notranslate nohighlight">\(K\)</span>, assumed to be the same in both directions. 	Units m<span class="math notranslate nohighlight">\(^2\)</span>s<span class="math notranslate nohighlight">\(^{-1}\)</span>, default value <span class="math notranslate nohighlight">\(10^4\)</span> m<span class="math notranslate nohighlight">\(^2\)</span>s<span class="math notranslate nohighlight">\(^{-1}\)</span>.</p></li>
<li><p><strong>tau_sub</strong> is  the subsidence drying timescale <span class="math notranslate nohighlight">\(\tau_{\text{sub}}\)</span> (in days, not seconds!). Default value <span class="math notranslate nohighlight">\(20\)</span> days.</p></li>
<li><p><strong>crh_ad</strong> is the strength of the moisture-convection feedback, i.e., the steepness <span class="math notranslate nohighlight">\(a_d\)</span> of the exponential function governing the choice of convective locations. Default is <span class="math notranslate nohighlight">\(14.72\)</span> from TRMM retrieval version 7</p></li>
<li><p><strong>crh_init_mn</strong> and <strong>crh_init_sd</strong> are the spatial mean and standard deviation of the initial <span class="math notranslate nohighlight">\(R\)</span> field.</p></li>
<li><p><strong>cnv_lifetime</strong> is the average lifetime of a convective event. Units seconds, default value <span class="math notranslate nohighlight">\(1800\)</span> s.</p></li>
<li><p><strong>nday</strong> and <strong>dt</strong> are the total simulated time (in days) and the model time step (in seconds).</p></li>
<li><p><strong>domain_xy</strong> and <strong>dxy</strong> are the domain size and horizontal resolution, both in meters.</p></li>
<li><p><strong>nfig_hr</strong> is the frequency of map slices (one map to be stored into a netcdf file/plotted)</p></li>
</ul>
</section>
<section id="questions">
<h3>Questions<a class="headerlink" href="#questions" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>What do you think is happening if we set <span class="math notranslate nohighlight">\(a_d = 0\)</span>? What does it mean in practice? Do we promote or prevent self-aggregation?</p></li>
<li><p>Equation (17) in the <a class="reference external" href="https://agupubs.onlinelibrary.wiley.com/doi/10.1029/2022MS003231">paper</a> predicts that aggregation is more likely at coarser resolutions, or larger domain sizes, or weaker diffusion, or stronger subsidence, or stronger convection-vapour feedback. Can you confirm some of these sensitivities with some experiments?</p></li>
<li><p>What if we change the convective lifetime to 2 hours (7200 <span class="math notranslate nohighlight">\(s\)</span>)? What do you expect is the impact on aggregation</p></li>
<li><p>What happens if we start with horizontally homogeneous very dry (<span class="math notranslate nohighlight">\(R(t=0) = 0.01\)</span>) or moist (<span class="math notranslate nohighlight">\(R(t=0)=1.05\)</span>) conditions?</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "None/None",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "conda"
        },
        kernelOptions: {
            name: "conda",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'conda'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#offline-users">Offline users:</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#let-s-run">Let’s run!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#changing-parameters">Changing parameters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#remember">remember!</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#model-parameters">Model Parameters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Adrian Tompkins
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>